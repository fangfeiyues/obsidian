
> 三步曲：做什么 -- 怎么做 -- 为什么
# 存储
MySQL存储要回答的几个问题（ 持续更新ing... ）
1. 怎么支持ACID？也就是写入过程保证原子性、持久性、隔离性和一致性 ...
2.  怎么支持高并发流量？写速度怎么保证、有没有缓存、怎么解决读写一致问题 ... 
3.  怎么保证高可用？宕机后怎么恢复、水平扩展怎么做的 ... 

在 [[MySQL 客户端]] 提到 `存储引擎` 即 提供对数据存储服务。先聊聊MySQL常用的 InnoDB（也可以说是 `表记录器`）
## 存储引擎InnoDB
###  InnoDB页
InnoDB存储引擎需要一条一条的把记录从磁盘上读出来么？不，那样会慢死。InnoDB采取的方式是：将数据划分为若干个页，以 页 作为 磁盘 和 内存 之间交互的基本单位，页的大小一般为 _**16**_ KB。

（数据页和页目录跟存储有什么关系。。）
#### Page 数据页
数据页里包含了数据记录

1.  File Header：38字节，？
2.  Page Header：56字节
3.  Infimum + supermum：
4.  User Records：大小不确定，存储记录的核心字段。大小从Free区域部分迁移过来
5.  Free Space：大小不确定
6.  Page Directory：大小不确定
7.  File Trailer：8字节

#### Page Directory页目录
记录存放在数据页后，那下一个问题是怎么在页面里找到这些记录？一条一条的过去肯定不现实。所以用到页目录，这可是好东西，能帮助我们快速找到对应的记录。当然这里还需要跟下面的  [[MySQL的存储&查询#记录头信息]]  。要达成一个目录的效果大概需要这几步：
1.  将所有正常记录划分为几个组
2.  每组的最后一条记录（也就是组内最大的那条记录）的头信息种 n_owned 表示该组有多少记录
3.  每组的最后一条记录的地址偏移量 存放到 页尾的Page Directory

![[MySQL页目录.png|600]]

这样我们找到一个数据页中指定记录的位置主要分为两步：
1.  通过二分法确定记录所在的槽，并找到该槽所在分组中主键值最小的记录
2.  通过记录 `next_record` 遍历该槽所在组的记录

> n_owned 作用是？
> 槽列表即目录页

### InnoDB行
InnoDB支持了4种不同类型的行格式，分别是 `Compact`、`Redundant`、`Dynamic` 和 `Compressed` 
```mysql
mysql> CREATE TABLE record_format_demo (
    ->     c1 VARCHAR(10),
    ->     c2 VARCHAR(10) NOT NULL,
    ->     c3 CHAR(10),
    ->     c4 VARCHAR(10)
    -> ) CHARSET=ascii ROW_FORMAT=COMPACT;
```


#### COMPACT行格式

![[Compact行格式.png|500]]

##### 额外信息
###### 变长字段长度
MySQL支持的一些变长的数据类型如VARCHAR(M)、VARBINARY(M)、各种TEXT类型等。

###### NULL值列表

###### 记录头信息
（  _**以下字段都很重要**_  ）
- 2个预留位
- `delete_mask`：该记录是否被删除
- `min_rec_mask`：B+树的每层非叶子节点种最小记录都会添加该标记
- `n_owned`：当前记录拥有的记录数。在数据页分组成索引的时候标记当前组的数量
- `heap_no`：当前记录在记录对的位置。
- `record_type`：记录类型（0 - 普通记录；1 - B+树非叶子节点记录；2 - 最小记录；3 - 最大记录）
- `next_record`：当前记录的真实数据到下一条记录的地址偏移量。比方说第一条记录的`next_record`值为`32`，意味着从第一条记录的真实数据的地址处向后找`32`个字节便是下一条记录的真实数据。就是链表

#### 真实数据
MySQL会为每个记录默认添加一些隐藏列，如
- `row_id`：唯一标识一条记录
- `transaction_id`：事务ID
- `roll_pointer`：回滚指针

#### Redundant行格式
是MySQL5.0前的格式，比较老了。




## 事务

## 日志



--- 

## 查询
MySQL查找要回答的几个问题（ 持续更新ing... ）
1.  怎么支持更多更快、以及范围查找模糊匹配...等能力
2.  怎么利用缓存解决高流量
3.  怎么保证高可用？宕机后怎么自动恢复

### 索引

### 构建索引

![[MySQL索引树.png]]

### 使用索引
