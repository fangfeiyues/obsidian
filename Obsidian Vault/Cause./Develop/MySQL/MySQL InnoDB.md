## 数据存储

### InnoDB行
InnoDB支持了4种不同类型的行格式，分别是 `Compact`、`Redundant`、`Dynamic` 和 `Compressed` 
```mysql
-- MySQL指定行格式方式 ROW_FORMAT = COMPACT
mysql> CREATE TABLE record_format_demo (
    ->     c1 VARCHAR(10)
    -> ) CHARSET=ascii ROW_FORMAT=COMPACT;
```

#### COMPACT行格式

![[Compact行格式.png|500]]

##### 1、额外信息
###### 1.1 变长字段长度
MySQL支持的一些变长的数据类型如VARCHAR(M)、VARBINARY(M)、各种TEXT类型等。
###### 1.2 NULL值列表

###### 1.3 记录头信息
（  _**以下字段都很重要**_  ）
- 2个预留位
- `delete_mask`：该记录是否被删除
- `min_rec_mask`：B+树的每层非叶子节点种最小记录都会添加该标记
- `n_owned`：当前记录拥有的记录数。在数据页分组成索引的时候标记当前组的数量
- `heap_no`：当前记录在记录对的位置。
- `record_type`：记录类型（0 - 普通记录；1 - B+树非叶子节点记录；2 - 最小记录；3 - 最大记录）
- `next_record`：当前记录的真实数据到下一条记录的地址偏移量。比方说第一条记录的`next_record`值为`32`，意味着从第一条记录的真实数据的地址处向后找`32`个字节便是下一条记录的真实数据。就是链表

##### 2、真实数据
###### 2.1 列值
###### 2.2 隐藏列
MySQL会为每个记录默认添加一些隐藏列，如
- `row_id`：唯一标识一条记录
- `transaction_id`：事务ID
- `roll_pointer`：回滚指针


#### 其他行格式
##### Redundant行格式
是MySQL5.0前的格式，比较老了




###  InnoDB页
知道了InnoDB存储行的方式，那么InnoDB会一条一条的把记录从磁盘上读出来么？不，那样会慢死。InnoDB采取的方式是：将数据划分为若干个页，以 页 作为 磁盘 和 内存 之间交互的基本单位，页的大小一般为 _**16**_ KB

（数据页和页目录跟存储有什么关系。。）
#### Page 数据页
数据包含的内容有如下
1.  File Header：38字节，？
2.  Page Header：56字节
3.  Infimum + supermum：
4.  User Records：大小不确定，存储记录的核心字段。大小从Free区域部分迁移过来
5.  Free Space：大小不确定
6.  Page Directory：大小不确定
7.  File Trailer：8字节
#### Page Directory页目录
记录存放在数据页后，那下一个问题是怎么在页面里找到这些记录？一条一条的过去不现实。
要用到页目录来快速定位记录 ，要达成一个目录的效果大概需要这几步：
1.  将所有正常记录划分为几个组
2.  每组的最后一条记录（也就是组内最大的那条记录）的头信息种 n_owned，表示该组有多少记录
3.  每组的最后一条记录的地址偏移量 存放到 页尾的Page Directory

![[MySQL页目录.png|600]]

这样我们找到一个数据页中指定记录的位置主要分为两步：
1.  通过二分法确定记录所在的槽，并找到该槽所在分组中主键值最小的记录
2.  通过记录 `next_record` 遍历该槽所在组的记录

## 数据查询
如上在说到数据存放在页的时候，提到了页也是有目录的。就是为了解决在一页又一页中寻找一条记录的问题。这个页目录页就是索引。

### 索引

#### 构建索引

![[MySQL索引树.png]]

索引有几方面因素构成：
1. 页号：并不是连续，只是建立双向链表关系
2. record_type：0（用户记录）、1（目录项纪录）、2（最小记录）、3（最大记录）
3. 下一页最小值
4. 下一页号

#### 使用索引
如果我们想找到如上主键为20的记录，需要以下几步：
1. 确定目录项记录页
2. 目录项 -->  真实页
3. 真实页 --> 具体记录

##### 聚簇索引
1. 使用记录主键值的大小进行记录和页的排序
	1. 页内记录按照主键大小单向链表排序（为什么不是双向？）
	2. 目录页也按照主键大小双向链表排序
	3. 存放记录页的不同层次也按照页中主键大小双向链表排序
2. B+树叶子节点存储的是完整的用户记录

##### 二级索引
1. 同上（主键 换成 对应的列）
2. B+树叶子节点存储只是 列 + 主键 两列的值

##### 联合索引
先把各个记录和页按照 a 列排序，在记录相同的情况下采用 b 列排序

##### 索引选择
**全值匹配**
**匹配左边的列**
**匹配列前缀**
**匹配范围值**
**索引交集** 


### Buffer Pool

innodb_buffer_pool_size = xxx * 1024 * 1024
