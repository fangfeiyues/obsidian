# 主从复制
Redis 的复制功能分为 同步(sync) 和 命令传播(command propagate) 
-  同步操作 用于将 从服务器的数据库状态 更新至 主服务器当前所处的数据库状态
-  命令传播 则用于在主服务器的数据库状态被修改，导致主从服务器不一致时，让主从回到一致

## 同步

![[Redis-3 分布式.png|500]]
### 旧版同步
简单总结旧版的 `SYNC命令` 是一个非常耗费资源的操作（ Redis 2.8前 ）
-  主服务器 需要执行`BGSAVE` 命令来生成 `RDB文件`，这个操作会耗费主服务器大量的 **CPU、内存 和 磁盘I/O**
-  主服务器 需要将自己生成的 RDB文件 发送给 从服务器，也会耗费大量的网络资源，并对主服务器响应命令请求时间产生影响
-  从服务器 接收到 RDB 文件 需要载入，并在载入期间从服务器会因为 阻塞 而不能处理命令请求


### 新版同步
Redis 从 2.8版本 开始使用 PSYNC命令 代替 SYNC命令 来执行复制时同步。PSYNC命令具有 完整重同步( full resynchronization ) 和 部分重同步( partial resynchronization )

#### 部分重同步
主要由三个部分构成

##### 复制偏移量 replication offset
执行复制的双方主从服务器分别会维护一个 复制偏移量 以来决定开始复制的位置
-  主服务器每次向从服务器传播N个字节数据，就将自己的复制偏移值加上N
-  从服务器每次收到主传来的N个字节数据，也将自己的复制偏移量值加上N

![[Redis-3 集群-部分重同步-复制偏移量.png|500]]

#### 复制积压缓冲区
是主服务器维护的一个固定长度先进先出队列，默认大小为1MB。保存着最近传播的写入命令，并且会为队列每个字节记录相应的复制偏移量，以决定是部分同步还是全量同步
1.  如果 offset 偏移量之后的数据还在复制缓冲区，那么对从服务器执行部分重同步
2.  如果 offset 偏移量不在缓冲区，那么还是执行完整重同步


#### 服务器运行ID
主服务器 根据 来同步的从服务器ID 决定之前是否同步过


### 复制实现

#### 步骤1：设置主服务器的地址和端口

```shell
127.0.0.1:12345> SLAVEOF 127.0.0.1 6379
OK
```

SLAVEOF 是个异步命令

#### 步骤2：建立套接字连接

-  从服务器会为这个套接字关联一个专门用于处理复制工作的文件处理器，复制后续接收RDB文件、写命令等
-  主服务器在接受accept从服务器套接字后，会将从服务器做为一个客户端看待

![[Redis-3 集群.png|400]]


#### 步骤3：发送PING命令
PING命令作用：检查 套接字读写状态 和 主服务器 双方是否正常工作
PING命令后会有3种情况
-  如果 主->从 但从不能在规定时间内读取内容，则从状态不佳，断开并重新创建套接字
-  如果 主->从 返回一个错误，则主表示无法处理服务，断开并重新创建套接字
-  如果 从 读取到 “PONG” 回复，则连接正常

#### 步骤4：身份验证

![[Redis-3 集群-1.png|400]]


#### 步骤5：发送端口信息






## Sentinel



## 集群

