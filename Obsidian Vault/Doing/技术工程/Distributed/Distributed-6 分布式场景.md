
##### 1、库存超卖&少卖

-  **解决方案（核心在于抗更高的并发 + 避免超卖）**

	缺陷方案：
	
		1. 数据库锁，无论是悲观锁还是乐观锁在Update的过程中都会阻塞，加大数据库压力
		2. SQL本身，update.. set a = a - 1 where a > 0 也是依赖数据库
		3. 分布式锁，多次通信带来的性能问题不如Lua脚本
	
	最终方案：
	
		4. 先在Redis中用Lua脚本扣件库存，保证原子性和一致性
		5. 再同步到数据库做扣减持久化
		但也可能在同步过程失败，就需要zset记录流水进行对账
	
	
	![[Pasted image 20250510155135.png|600]]

-  **业务流程**
  
	![[Pasted image 20250510145513.png|500]]

##### 2、商品秒杀

[[01. 设计一个秒杀系统]]

-  **解决方案**
  	
	1. 瞬时流量 --> 流量随机过滤，从客户端、CDN、Nginx、Web应用、缓存、数据库等
	2. 热点数据 --> 预热 + 数据拆分
	3. 数据量大 --> 分库分表
	4. 库存扣减 --> 【如上】
	5. 黄牛抢购 --> 风控算法
	6. 重复下单
	7. 对普通交易的影响 --> 隔离？
	8. ...
	


-  **业务流程**

	1.  发起秒杀 
	2.  服务校验（链式校验） 
	3.  返回秒杀价格 
	4.  提交订单  
	5.  处理库存扣减
	
	![[image-01. 设计一个秒杀系统-20240701201858151.png|600]]