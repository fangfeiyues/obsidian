---

DDD的核心思想：
-> 领域驱动设计方法 
—> 定义领域模型
—> 确定业务边界及应用边界
—> 保证业务模型与代码模型的一致性
（待补充..）

---

## 01、领域驱动设计为什么要选择DDD

### 微服务设计和拆分的困境

微服务拆分过度导致项目的复杂度过高，原因就是对微服务理解过于片面。其根本原因是不知道 业务边界 或 微服务的边界 到底在哪，换句话说 --> 确定了业务边界和应用边界，这个困境也就引刃而解

由此DDD应运而生其核心思想是：通过领域驱动设计方法定义领域模型，从而确定业务和应用边界，保证业务模型与代码模型一致性。（问题在于是怎么通过领域设计定义模型的？进而影响边界的？）

### 战略设计-事件风暴

```
要解决上述问题可以从「事件风暴」入手
-> 通过分析业务操作、事件以及外部依赖等梳理出领域对象从而定义领域模型
-> 然后通过模型之间的关联性形成聚合
-> 再根据语义将多个聚合划定再一个限界上下文内
```

我们可以用三步来划定领域模型和微服务的边界：

- **领域对象梳理**

	事件风暴中梳理业务过程中的用户操作 、事件以及外部依赖关系，然后根据这些要素梳理出领域实体等领域对象如实体、值对象等

-  **聚合边界**

	根据实体之间的业务关联性，形成聚合边界

- **上下文边界**

	根据业务及语义边界等因素将一个或者多个聚合划定在一个限界上下文，形成上下文边界


DDD不是架构而是一种架构设计方法论，它通过边界划分将复杂业务领域简单化，帮我们设计出清晰的领域和应用边界，可以很容易的实现架构演进。 [[DDD-02 战略设计]]


### DDD vs 微服务

- **DDD 关注点**

	业务领域视角划分领域边界，构建通用语言进行高效沟通，通过业务抽象，建立领域模型，维持业务和代码的逻辑一致性


- **微服务关注点**

	运行时的进程间通信、容错和故障隔离，实现去中心化数据管理和去中心化服务治理，关注微服务的独立开发、测试、构建和部署

## 02、领域、子域、核心域、通用域和支撑域

领域就是用来确定范围的，范围即边界这也是DDD在设计中不断强调边界的原因

核心域、支撑域和通用域的主要目标是通过领域划分，区分不同子域在公司内的不同功能属性和重要性，从而公司可对不同子域采取不同的资源投入和建设策略，其关注度也会不一样。

```
摘录一段关于子域和限界上下文的关系：

1、子域的划分是一种比较粗的领域边界划分，它不考虑子域内的领域对象、领域对象之间的关系和结构。
 （比如分销员的客户子域、账号子域等）子域的划分往往按照业务阶段或功能模块边界进行粗分，
  其目的就是为了让你在一个相对较小的空间内比较方便的用事件风暴梳理业务场景
  
2、限界上下文体现的是一种详细的设计过程，这个过程设计出了领域模型，明确了领域对象及其依赖关系。
```

## 03、限界上下文：定义领域边界的利器

### 通用语言

1.  在事件风暴过程中，达成共识且能描述业务含义的语言就是通用语言
2.  通用语言 = 术语 + 用例场景，并且能直接反映在代码中

设计过程中我们可以用一些表格来记录事件风暴和微服务设计过程中产生的领域对象及其属性

![[image-DDD-04 落地-20240510145510127.png]]


### 限界上下文 Bounded Context

```
用来封装通用语言和领域对象，提供上下文环境，保证在领域之内的一些术语、业务等相关对象有一个确切的含义

比如分销员ds_uid其本质是和用户域的id不一样的但因为边界没划分清晰导致现在账号合并侵蚀太多逻辑，云分销也有这种问题比如手机号这种产物… 还有之前说的店铺kdtId、连锁模型等
```

![[image-DDD-04 落地-20240510145452224.png|400]]


## 04、实体和值对象：从领域模型的基础单元看系统设计

### 实体

-  **业务形态**

	在事件风暴中可以根据命令、操作或者事件找出产生这些行为的「业务实体对象」，进而按照一定的业务规则将依存度高和业务关联紧密的多个实体对象和值对象进行聚类

- **代码形态**

	充血模型，与这个实体相关的所有业务逻辑都在实体类的方法中实现，跨多个实体的领域逻辑则在领域服务中实现

-  **运行形态**

	每个实体对象都有唯一的ID

-  **数据库形态**


这几个方面的总结虽然不深刻但挺有条理，能相对清晰的理解实体

### 值对象

简单来说值对象本质上就是一个集合。其中用于描述目的、具有整体概念和不可修改的属性。其意义在于领域建模过程中值对象可以保证属性归类的清晰和概念的完整性。

## 05、聚合和聚合根：怎样设计聚合？

在事件风暴中我们会根据一些业务操作和行为找出实体或值对象，进而将业务关联紧密的实体和值对象进行组合构成**聚合**。再根据业务语义将多个聚合划定到同一个限界上下文中，并在限界上下文内完成领域建模

聚合根的主要目的是为了避免由于复杂数据模型缺少统一的业务规则控制，而导致聚合、实体事件数据不一致的问题

### 怎么设计聚合根？

1.  事件风暴找出实体和值对象
2.  找出聚合根
3.  找出聚合
4.  对象（上下文内）引用和依赖关系

### 聚合设计的一些原则

1.  不变条件原则：聚合用来封装真正的不变性，而不是简单的将对象组合在一起
2.  小聚合原子：聚合决定这稳定性，越小越清晰越稳定
3.  唯一标识标识原子：通过唯一性引用其他聚合
4.  在边界之外使用最终一致性。聚合内数据强一致性而聚合之间数据最终一致性，再一次事务中最多只能更改一个聚合的状态
5.  通过应用层实现跨聚合的服务调用

## 06、领域事件：解耦微服务的关键

领域事件DominEvent 处理包括：
1. 事件构建和发布。至少包括事件唯一标识、发生时间、事件类型和事件源以及业务属性用于记录发生那一刻的业务数据
2. 事件数据持久化。（实用性不大）
3. 事件总线（EventBus）。提供事件分发和接受等服务，它会在微服务内聚合之间遍历订阅者列表采用同步或异步模式传递数据。
4. 消息中间件
5. 事件接受和处理

![[image-DDD-04 落地-20240510145425442.png]]


01-06

总结下前六章讲的东西核心有两层：
一个是领域设计能带来什么，也就是在解决了什么微服务的问题（业务边界问题）这是核心 ；
二个是怎么解决的（通过子域、限界上下文、实体对象、聚合等）。

大致了解了之后就会有一个很关键的问题，怎么在脑爆之后设计出一个领域模型呢？？？

---

（前面大概讲了领域驱动设计的概念、解决的问题以及一些基本路径）

## 07、DDD分层架构：有效降低层与层之间的依赖

四层架构：

![[image-DDD-04 落地-20240510145401334.png|500]]

核心改变在：
1.  接口层 只依赖 应用层，领域层不再直接服务接口层
2.  应用层 只依赖 领域层，基础层不再直接服务应用层
3.  基础层使用依赖倒置，正常是领域层依赖基础层做数据处理，但现在是基础层会依赖领域层的协议，来保证服务稳定。同时作为最上层消息、缓存等直接调用接口层或应用层

三层 与 DDD四层架构之间的映射关系：

![[image-DDD-04 落地-20240510145341954.png|500]]


这里核心在于

1. DDD架构将业务逻辑层的服务拆分到了应用层和领域层，应用层快速响应前端的变化、领域层实现领域模型的能力
2. 在数据访问层和基础层之间采用了仓储Repository设计模式，通过依赖倒置实现各层对基础资源的依赖

## 08、微服务架构模型：几种常见模型的对比和分析

### 整洁架构

又称为”洋葱架构”。

![[image-DDD-04 落地-20240510145305590.png|500]]

### 六边形架构

可以看出无论是DDD分层架构还是整洁结构（洋葱架构）或者六边形架构都是以领域模型为核心，实行分层架构，内部核心业务逻辑与外部应用、资源隔离并解耦。

![[image-DDD-04 落地-20240510145226624.png|500]]


六边形架构将系统分为

1. 内六边形：实现应用的核心业务逻辑
2. 外六边形：完成外部应用、驱动和基础资源的交互和访问，对前端应用以api主动适配，对基础资源以依赖倒置被动适配；

### 三种架构的对比&分析

![[image-DDD-04 落地-20240510145157008.png|500]]


架构模型通过分层的方式来控制需求变化从外到里对系统的影响，从外向里受需求影响逐步减小。
面向用户的前端可以快速响应外部需求进行调整和发布，灵活多变，应用层通过服务组合和编排来实现业务流程的快速适配上线，减少传导到领域层的需求，使领域层保持长期稳定。
这样设计的好处很明显了，就是可以保证领域层的核心业务逻辑不会因为外部需求和流程的变动而调整，对于建立前台灵活、中台稳固的架构很有帮助

## 09、中台：数字转型后到底该共享什么？

```
 阿里业务中台的目标是把核心服务链路（会员、商品、交易、营销、店铺、资金结算等）整体当作一个平台产品来做，为前端业务提供的是业务解决方案而不是彼此独立的系统。
```

### 平台是不是中台？

```
平台只是将部分通用的公共能力独立为共享平台。虽然可以通过API或者数据对外提供公共服务解决系统重复建设的问题，但这类平台并没有和企业内的其他平台或应用实现页面、业务流程和数据从前端到后端的全面融合，并且没有将核心业务服务链路作为一个整体方案考虑，各个平台仍然是分离且独立的。
```

### 中台做什么？

几个关键词：共享、联通、融合和创新。

```
看一下阿里自己人对中台的定义：“中台是一个基础的理念和架构，我们要把所有的基础服务用中台的思路建设，进行联通，共同支持上端的业务“。

业务中台更多的是支持在线业务，数据中台提供了基础数据处理能力和很多的数据产品给所有业务方去用。业务中台、数据中台、算法中台等等一起提供对上层业务的支撑
```

中台来源于平台，但中台和平台相比，它更多体现的是一种理念的转变，它主要体现在这三个关键能力上：
1.  对前台业务的快速响应能力
2.  企业级复用能力
3.  从前台、中台到后台的设计、研发、页面操作、流程服务和数据的无缝联通、融合能力

### 数字化转型中台应该共享什么？

![[image-DDD-04 落地-20240510145118907.png|500]]


由于渠道的多样化，

1. 传统企业不仅要将通用能力中台化以实现通用能力的沉淀、共享和复用，这里的通用能力对应DDD的通用阈或支撑阈；
2. 传统企业还要将核心能力中台化以满足不同渠道的核心业务能力共享和复用，这里就对应DDD的核心域

这就是术语业务中台的范畴，我们需要解决核心业务链路的联通和不同渠道服务共享的问题，除此之外我们还需要解决数据孤岛、数据融合和业务创新等问题这就是数据中台范畴。

数据中台核心职能：

1. 完成企业全域数据的采集与存储，实现不同业务类别中台数据的汇总和集中管理
2. 按照标准的数据规范或数据模型，将数据按照不同主题域或常见进行加工处理形成面向不同主题和场景的数据应用
3. 建立业务需求驱动的数据体系，基于各个纬度的数据深度萃取数据价值支持业务和商业模式创新

理解下来数据中台核心职责就采集、形成数据模式（如汇聚展示）、支持商业创新（数据分析）

## 10、DDD、中台和微服务：它们是如何协作？

```
1、中台是抽象出来的业务模型
2、微服务是业务模型的系统实现
3、DDD是作为方法论可以同时指导中台业务建模和微服务建设
三者相辅相成
```

![[image-DDD-04 落地-20240510145041432.png|600]]


### 中台如何建模

1. 按照业务流程或者功能属性、集合将业务域细分为多个中台，再根据功能属性或重要性归类到核心中台或通用中台
2. 选取中台。根据业务用例、业务场景或用户旅程完成事件风暴，找出实体、聚合和限界上下文。一依次进行领域分解建立领域模型
3. 以主领域模型为基础扫描其他中台领域模型，检查并确定是否存在重复或需要重组的领域对象并重构主领域模型
4. 选择其他主领域模型重复第三步
5. 基于领域模型完成微服务设计

# 11、DDD实践：如何用DDD重构中台业务模型？

## 如何构建中台业务模型？

有两种建模策略：「自顶向下」和 「自底向上」

### 自顶向下

这种策略是先做顶层设计，从最高领域逐步分解为中台分别建立领域模型，根据业务属性分为通用中台或核心中台。建模过程主要基于业务现状暂不考虑系统现状，适用于全新的应用系统建设。

**建模方式**
1.  领域分解为子域，子域可以分为核心域、通用域和支撑域
2.  对子域建模，划分领域边界，建立领域模型和限界上下文
3.  根据限界上下文进行微服务设计

### 自底向上

是基于业务和系统现状完成领域建模，适用于遗留系统业务模型的演进式重构。

首先分别完成系统所在业务域的领域建模然后对对齐业务域找出具有同类或相似业务功能的领域模型，对比分析领域模型的差异重组领域对象，重构领域模型。这个过程会沉淀公共和复用的业务能力，会将分散的业务模型整合。

**建模方式**
1. 锁定系统所在业务域，构建领域模型（事件风暴、领域对象、构建聚合、划分限界上下文，建立模型等）
2. 对齐业务域，构建中台业务模型（业务沉淀）
3. 中台归类，根据领域模型设计微服务（重新审视）

### 用户活动

上面的两种方式其实只是在比较理想的情况下的一种策略，像复杂且大的系统如ebiz-salesman领域众多且难以隔离的情况下自底向上重构有几个风险：
1. 上层依赖众多，改动回归点大
2. 迁移过程中就可能出现“真空”接口，当前没有实际业务接入

# 12、领域建模：如何用事件风暴构建领域模型？

## 产品愿景

目的是对产品顶层价值的设计，使产品目标用户、核心价值、差异化竞争点等信息达成一致，避免产品偏离方向

## 业务场景分析

场景分析是从用户视角出发，根据业务流程，采用用例和场景分析，探索领域中的典型场景，找出领域事件、实体和命令等领域对象，支撑领域建模。

## 领域建模

领域建模时，我们会根据场景分析过程中产生的领域对象，比如命令、事件等之间关系找出产生命令的实体，分析实体之间的依赖关系组成聚合，为聚合划定限界上下文，建立领域模型以及模型之间的依赖。领域模型利用 _限界上下文_ 向上指导微服务设计，通过聚合向下指导聚合根、实体和值对象设计。

根据业务场景找出领域对象，具体可分为三步
1. 从命令和事件中提取产生这些行为的**实体**
2. 根据聚合根的管理性质从实体的**聚合根**
3. 划定**限界上下文**，根据上下文语义将聚合归类

# 13、代码模型（上）：如何使用DDD设计微服务代码模型

微服务目录结构：

1. application
    1. Event
        1. publish：事件发布
        2. subscribe：事件订阅
    2. Service：封装、编排和组合
2. domain
    1. aggregate：聚合内是高内聚的业务逻辑，可以独立拆分微服务
    2. Entity：实体、值对象、工厂模式等
    3. Event：实体或聚合事件
    4. Service：领域服务
    5. Repository：仓储
3. infrastructure
    1. config
    2. utils
4. interfaces
    1. assembler：实现DTO与领域对象之间的相互转换
    2. dto：与外界隔离
    3. facade

	![[image-DDD-04 落地-20240510144843373.png|400]]


# 14、代码模型（下）：如何保证领域模型与代码模型的一致性

没啥讲头…

# 15、边界：微服务的各种边界在架构演进中的作用

## 演进式架构

在最开始提出微服务的时候就有一个重要特性 — 演进式架构。那什么是演进式架构呢？演进式架构就是以支持增量的、非破坏的变更作为第一原则，同时支持在应用程序层面的多维度变化。这也就是微服务设计的重点：微服务的设计能够支持架构长期、轻松的演进。

所以微服务是小单体还是大泥球不重要，钟头的是边界

## 微服务边界的作用

 在事件风暴中，我们会梳理出业务过程中的用户操作、事件以及外部依赖关系等，根据这些要素梳理出实体等领域对象。根据实体对象之间的业务关联性，将业务紧密相关的多个实体进行组合形成聚合，聚合之间是第一层边界。根据业务及语义边界等因素将一个或者多个聚合划定在一个限界上下文内，形成领域模型，限界上下文之间的边界是第二层边界

### 三层边界

1. 逻辑边界
2. 物理边界
3. 代码边界

# 16、视图：如何实现服务和数据在微服务各层的协作？