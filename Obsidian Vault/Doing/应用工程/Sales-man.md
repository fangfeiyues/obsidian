

## 云分销

	[背景] 随着分销市场玩法的不断成熟，一级分销逐渐难以满足日益复杂的多层级裂变和分佣模式
    [需求] 从0到1搭建包括上下级团队、多层分佣、数据统计、推广奖励等在内的分销系统
    [核心] 
		1. 基于分布式与状态机模型，通过逆向流转状态保证订单创建、支付、取消等的最终一致性，解决“不分佣”的问题
		2. 用多版本快照，构建多版本节点视图，保证其变更前后的可重复度，解决“佣金该分给谁”的问题
		3. 借鉴DDD战略思想，构建清晰的上下文边界和内聚的领域模型，确保业务与代码模型一致性，避免大煤球式开发
	[结果] 补齐多级分销的业务场景，并在次年就带来了1500w+收益。并通过良好的架构设计快速支持业务的发展


-  **1、分销领域模型**
  
	![[Pasted image 20250305150511.png|600]]

		 1. 领域是怎么划分 （对上开放 + 对下解耦 -> 抽象 + 稳定）
			1. 分销商域：分销员、团队、名片等实体
			2. 客户域：我的客户、客户关系等实体
			3. 订单域：订单、分佣明细等实体
			4. 结算域：结算明细等实体
			5. 激励域：任务完成记录、奖励等实体
	
		1. 领域能解决什么问题
			1. 抽象稳定
				1. 抽象，如SPI依赖倒置下游避免下游服务更新而带来耦合问题，如转账接口
				2. 稳定，如应用层不应直接调用仓储层，如分销员的升级？数据的更新？（面向场景还是面向领域）
			2. 平台化：开放边界
			   
		3. 领域怎么划分
			1. 头脑风暴？如客户和分销商之间是否可以划分为一个域 ？？？
			2. 各域之间、上下文之间的松耦合，可以独立替换或扩展。如客户关系、分佣计算规则等可以有三方
			   
		4. 具体怎么落地
			1. 自上而下
			2. 自下而上
			3. 场景落地
			   
		5. 遇到什么技术难题
			1. 一致性：消息乱序、
			2. 数据一致性：MVCC快照可重复读
			3. 分布式事务：？？


## 分销员


	[背景] 分销员是有赞商城TOP3流量插件，其稳定性重中之重，但经过6年+的发展其系统漏洞不断亟需治理
	[需求] 根解线上的高频资损问题、缓解每周50+线上jira、规避高流量下系统的不稳定性、并合理规划架构演变
    [核心] 
	    1. 高流量治理：分布式限流 + Redis有序集合，来自动隔离窗口期的高流量到vip通道，避免影响正常业务
        1. 性能优化：通过优化SQL索引、Hot Key高频更新、CPU飙升等问题解决机器压力？
        2. 资损防控：治理因分布式导致的最终不一致问题，并建立离线对账、资损监测等防控体系
    [结果] 潜在资损问题修复80%以上、每周线上问题下降30%、线上错误日志及告警下降50%以上，保障业务平稳发展


-  **高流量治理**

		1. 热点更新：分布式限流 + Redis zset窗口


-  **SQL优化**

		1. 最左匹配丢失
		2. 使用大量函数查询
		3. order by id（主键索引 + where）
	    1. 索引字段区分度不高，如 kdt_id + state


-  **资损防控**

		1. 离线对账
		2. 实时脚本


-  **架构优化及稳定性通用沉淀方案**
